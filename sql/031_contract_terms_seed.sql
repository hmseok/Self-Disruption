-- ================================================================
-- Self-Disruption ERP: 약관 시드 데이터
-- 031_contract_terms_seed.sql
-- ================================================================
-- 메리츠캐피탈 자동차 장기대여 표준약관(25년 11월) 기반 커스터마이즈
-- ※ 실무 사용 전 법률 전문가 검토 필요
-- ================================================================

-- 모든 회사에 기본 약관을 넣기 위해 company_id를 동적으로 가져옴
-- 첫 번째 회사에만 시드 (추후 각 회사가 자체 약관 생성)

DO $$
DECLARE
  v_company_id UUID;
  v_terms_id BIGINT;
BEGIN
  -- 첫 번째 회사 ID 가져오기
  SELECT id INTO v_company_id FROM companies LIMIT 1;
  IF v_company_id IS NULL THEN
    RAISE NOTICE '회사가 없어 시드 생략';
    RETURN;
  END IF;

  -- 이미 약관이 있으면 스킵
  IF EXISTS (SELECT 1 FROM contract_terms WHERE company_id = v_company_id) THEN
    RAISE NOTICE '이미 약관 존재, 스킵';
    RETURN;
  END IF;

  -- ── 약관 세트 생성 ──
  INSERT INTO contract_terms (company_id, version, title, description, status, effective_from)
  VALUES (
    v_company_id,
    'v1.0 (2026-02)',
    '자동차 장기대여(렌트) 약관',
    '초기 약관 — 여객자동차운수사업법 및 메리츠캐피탈 표준약관(25.11) 참고 작성',
    'active',
    CURRENT_DATE
  )
  RETURNING id INTO v_terms_id;


  -- ── 개별 조항 삽입 ──
  INSERT INTO contract_term_articles (terms_id, article_number, title, content, category) VALUES

  -- ━━━ 일반 ━━━
  (v_terms_id, 1, '계약의 내용',
   '① 본 약관은 임대인(이하 "회사")이 임차인(이하 "고객")에게 자동차를 장기대여함에 있어 양 당사자의 권리·의무 및 기타 필요한 사항을 규정합니다.
② 개별 계약서에 기재된 차량정보, 대여기간, 렌탈료, 보증금, 약정주행거리, 정비상품, 보험조건, 특약사항 등은 본 약관과 함께 계약의 내용을 구성합니다.
③ 개별 계약서와 본 약관의 내용이 상충하는 경우, 개별 계약서의 내용이 우선합니다.',
   'general'),

  (v_terms_id, 2, '대여기간',
   '① 대여기간은 개별 계약서에 기재된 시작일부터 종료일까지로 합니다.
② 대여기간은 차량 인도일(고객이 실제 차량을 수령한 날)부터 기산합니다.
③ 차량 인도가 지연되는 경우, 회사는 지연 사유를 고객에게 통지하여야 하며, 지연 기간에 대한 렌탈료는 발생하지 않습니다.',
   'general'),

  -- ━━━ 렌탈료/보증금/선납금 ━━━
  (v_terms_id, 3, '렌탈료 및 납부',
   '① 고객은 개별 계약서에 기재된 월 렌탈료(부가가치세 별도)를 매월 약정 납부일에 회사가 지정한 방법으로 납부하여야 합니다.
② 렌탈료에는 자동차세(지방교육세 포함), 책임보험료, 약정 정비비가 포함됩니다.
③ 렌탈료를 연체하는 경우, 연체금액에 대하여 연 12%의 지연이자가 가산됩니다.
④ 3회 이상 연속 또는 누적 5회 이상 연체 시, 회사는 본 계약을 해지할 수 있으며, 이 경우 제20조가 적용됩니다.',
   'payment'),

  (v_terms_id, 4, '보증금',
   '① 고객은 계약 체결 시 개별 계약서에 기재된 보증금을 납부합니다.
② 보증금은 무이자이며, 계약 종료 시 차량 반납 완료 및 정산(미납 렌탈료, 초과주행수수료, 원상복구비용 등) 후 잔액을 반환합니다.
③ 보증금은 렌탈료와 상계할 수 없습니다.',
   'payment'),

  (v_terms_id, 5, '선납 렌탈료',
   '① 고객이 선납금을 납부하는 경우, 선납금은 대여기간에 걸쳐 월 렌탈료에 균등 차감 적용됩니다.
② 선납금 적용 후 월 렌탈료 = (기본 월 렌탈료) - (선납금 ÷ 계약개월수)
③ 중도해지 시 미경과 기간에 해당하는 선납금 잔액은 제15조의 중도해지수수료와 상계 후 반환됩니다.',
   'payment'),

  -- ━━━ 보험/사고 ━━━
  (v_terms_id, 6, '운전자 자격요건',
   '① 차량을 운전할 수 있는 자는 개별 계약서에 기재된 운전자 범위로 한정합니다.
② 고객은 약정 운전자 외의 자에게 차량 운전을 허용하여서는 안 됩니다.
③ 약정 범위 외 운전자가 운전 중 발생한 사고에 대해서는 보험 면책이 적용되지 않을 수 있으며, 이로 인한 손해는 고객이 부담합니다.',
   'insurance'),

  (v_terms_id, 7, '보험',
   '① 회사는 다음 각 호의 보험에 가입합니다.
  가. 대인배상Ⅰ: 법정 한도 (의무보험)
  나. 대인배상Ⅱ: 무한
  다. 대물배상: 개별 계약서에 기재된 한도
  라. 자기신체사고(자손): 개별 계약서에 기재된 한도
  마. 자기차량손해(자차): 개별 계약서에 기재된 면책금 조건
② 자차보험 사고 시 고객은 개별 계약서에 기재된 면책금을 부담합니다.
③ 다음 각 호의 경우 보험 보상이 제한되며, 고객이 전액 부담합니다.
  가. 음주운전, 무면허운전, 약물복용 후 운전
  나. 고의 또는 중대한 과실에 의한 사고
  다. 약정 운전자 범위 외의 자에 의한 사고
  라. 차량을 범죄 행위에 사용한 경우',
   'insurance'),

  (v_terms_id, 8, '사고 처리',
   '① 사고 발생 시 고객은 즉시 다음 조치를 취하여야 합니다.
  가. 부상자 구호 및 경찰 신고
  나. 회사 고객센터에 사고 통보
  다. 사고 현장 사진 촬영 및 상대방 정보 확보
② 경찰 신고 없이 사고 당사자 간 합의(사적 합의)를 한 경우, 보험 처리가 제한될 수 있으며, 이로 인한 추가 비용은 고객이 부담합니다.
③ 사고 차량의 수리는 회사가 지정하는 정비업체에서 실시함을 원칙으로 합니다.
④ 수리 기간 중 대차 제공은 보험 약관 및 개별 계약서에 따릅니다.',
   'insurance'),

  (v_terms_id, 9, '차량의 멸실·훼손에 따른 원상복구',
   '① 대여기간 중 차량이 멸실·훼손된 경우, 고객은 원상복구 의무를 부담합니다.
② 보험으로 보상되지 않는 수리비, 감가손실, 영업손실 등은 고객이 부담합니다.
③ 차량이 전손(수리 불가 또는 수리비가 차량 가액을 초과)된 경우, 계약은 종료되며 잔여 렌탈료 및 잔존가치 차액에 대하여 정산합니다.',
   'vehicle'),

  -- ━━━ 차량 관리 ━━━
  (v_terms_id, 10, '차량의 관리 및 사용',
   '① 고객은 선량한 관리자의 주의의무로 차량을 관리·사용하여야 합니다.
② 교통법규 위반으로 인한 범칙금, 과태료, 주정차 위반 과태료, 견인비 등은 고객이 부담합니다.
③ 차량의 정기검사(종합검사)는 회사가 책임지고 실시합니다.
④ 고객은 차량에 이상이 발견된 경우 즉시 회사에 통보하여야 합니다.',
   'vehicle'),

  (v_terms_id, 11, '차량의 사용 제한 및 금지사항',
   '① 고객은 다음 각 호의 행위를 하여서는 안 됩니다.
  가. 차량을 제3자에게 전대, 양도, 담보 제공
  나. 차량의 구조·장치를 임의로 변경(튜닝, 외장 변경 등)
  다. 차량으로 유상 운송(택시, 대리운전, 화물운송 등) 행위
  라. 차량을 경주, 시험, 훈련 등 비정상적 용도로 사용
  마. 차량을 국외로 반출
② 전항을 위반한 경우, 회사는 즉시 계약을 해지하고 차량 반납을 요구할 수 있으며, 이로 인한 손해를 고객에게 청구할 수 있습니다.',
   'vehicle'),

  -- ━━━ 정비 ━━━
  (v_terms_id, 12, '정비 서비스',
   '① 약정 정비상품에 따른 정비 서비스 범위는 다음과 같습니다.
  가. 자가정비: 모든 정비비용 고객 부담
  나. 오일류만: 엔진오일, 미션오일 등 유류 교체비 회사 부담
  다. 기본정비: 소모품(오일, 필터, 브레이크패드 등) 교체비 회사 부담
  라. 완전정비: 소모품 + 타이어, 배터리 등 주요 부품 교체비 회사 부담
② 정비는 회사가 지정하는 정비업체 또는 제조사 공식 서비스센터에서 실시합니다.
③ 고객의 과실(사고, 부주의, 오용 등)로 인한 수리비는 정비상품과 무관하게 고객이 부담합니다.
④ 전기차의 경우 고전압 배터리는 제조사 보증 범위에 따르며, 정비상품 적용 대상에서 제외됩니다.',
   'maintenance'),

  -- ━━━ 주행거리 ━━━
  (v_terms_id, 13, '약정주행거리',
   '① 연간 약정주행거리는 개별 계약서에 기재된 바에 따릅니다.
② 약정 총주행거리 = 연간 약정주행거리 × (대여기간 ÷ 12개월)
③ 약정주행거리 미달 시에는 별도의 환급이 없습니다.',
   'mileage'),

  (v_terms_id, 14, '초과주행수수료',
   '① 계약 종료 시(반납 또는 인수) 총 주행거리가 약정 총주행거리를 초과한 경우, 초과분에 대하여 초과주행수수료를 정산합니다.
② 초과주행수수료 = 초과 주행거리(km) × 개별 계약서에 기재된 초과주행 단가(원/km)
③ 초과주행 단가는 계약 체결 시 확정되며, 계약 기간 중 변경되지 않습니다.
④ 인수형 계약의 경우에도 인수 시점의 주행거리가 약정을 초과하면 초과주행수수료가 적용됩니다.',
   'mileage'),

  -- ━━━ 해지/반납/인수 ━━━
  (v_terms_id, 15, '중도해지',
   '① 고객이 대여기간 만료 전 중도해지를 요청하는 경우, 다음의 중도해지수수료가 부과됩니다.
② 중도해지수수료 산정:
  가. 잔여기간 12개월 초과: 잔여 렌탈료의 30%
  나. 잔여기간 6~12개월: 잔여 렌탈료의 20%
  다. 잔여기간 6개월 미만: 잔여 렌탈료의 10%
③ 보증금 및 선납금 잔액은 중도해지수수료, 미납 렌탈료, 초과주행수수료 등을 공제한 후 반환합니다.
④ 천재지변, 차량 전손, 고객 사망 등 불가항력적 사유에 의한 해지 시에는 수수료를 감면할 수 있습니다.
⑤ 중도해지 시 차량 반납에 대해서는 제17조가 준용됩니다.',
   'termination'),

  (v_terms_id, 16, '차량의 반납',
   '① 반납형 계약의 고객은 대여기간 만료일까지 차량을 회사 지정 장소에 반납하여야 합니다.
② 반납 시 회사와 고객이 공동으로 차량 상태(외관, 내부, 주행거리, 옵션 장비 등)를 점검합니다.
③ 정상적인 사용에 따른 자연 마모를 초과하는 손상에 대해서는 원상복구 비용이 고객에게 청구됩니다.
④ 반납 지연 시 지연일수에 대하여 일할 렌탈료의 150%가 부과됩니다.
⑤ 차량에 부착된 고객의 부속물·장비는 반납 전 원상복구하여야 합니다.',
   'termination'),

  (v_terms_id, 17, '반납 차량의 정산',
   '① 반납 시 다음 항목에 대하여 정산을 실시합니다.
  가. 초과주행수수료 (제14조)
  나. 차량 손상 원상복구 비용 (제9조)
  다. 미납 렌탈료 및 지연이자
  라. 교통법규 위반 과태료 미정산분
② 정산금액은 보증금에서 공제하며, 보증금을 초과하는 경우 고객에게 별도 청구합니다.
③ 정산은 차량 반납일로부터 30일 이내에 완료하며, 보증금 잔액은 정산 완료 후 14영업일 이내에 반환합니다.',
   'termination'),

  (v_terms_id, 18, '차량의 인수',
   '① 인수형 계약의 고객은 대여기간 만기 시 개별 계약서에 기재된 인수가격을 납부하고 차량 소유권을 이전받을 수 있습니다.
② 인수가격에는 부가가치세가 별도 부과됩니다.
③ 고객이 인수가격을 납부한 날로부터 7영업일 이내에 회사는 소유권 이전에 필요한 서류를 교부합니다.
④ 인수 시에도 약정주행거리 초과분에 대한 초과주행수수료는 정산됩니다.
⑤ 고객이 인수를 포기하는 경우, 제16조 및 제17조(반납 및 정산)가 준용됩니다.',
   'termination'),

  -- ━━━ 해지/위약 ━━━
  (v_terms_id, 19, '회사에 의한 계약 해지',
   '① 회사는 다음 각 호의 사유가 발생한 경우 사전 통지(14일) 후 계약을 해지할 수 있습니다.
  가. 렌탈료를 3회 이상 연속 또는 누적 5회 이상 연체한 경우
  나. 제11조의 금지사항을 위반한 경우
  다. 차량을 이용하여 범죄행위를 한 경우
  라. 고객이 파산, 회생절차를 신청한 경우
  마. 기타 계약의 계속이 현저히 곤란한 중대한 사유가 발생한 경우
② 회사에 의한 해지 시에도 고객은 중도해지수수료(제15조) 및 정산 의무를 부담합니다.
③ 해지 통보 후 고객이 7일 이내에 차량을 반납하지 않는 경우, 회사는 차량을 회수할 수 있으며, 이에 소요되는 비용은 고객이 부담합니다.',
   'penalty'),

  (v_terms_id, 20, '지연배상금',
   '① 고객이 렌탈료, 중도해지수수료, 초과주행수수료, 원상복구비용 등 본 계약에 따른 금전채무를 연체하는 경우, 연체금액에 대하여 연 12%의 지연배상금이 가산됩니다.
② 지연배상금은 납부기일 다음날부터 실제 납부일까지 일할 계산합니다.',
   'penalty'),

  -- ━━━ 개인정보/기타 ━━━
  (v_terms_id, 21, '개인정보 수집·이용 동의',
   '① 회사는 계약 이행을 위해 다음의 개인정보를 수집·이용합니다.
  가. 수집항목: 성명, 연락처(휴대전화), 이메일, 주소, 운전면허 정보
  나. 이용목적: 자동차 장기대여 계약 체결·이행, 보험 가입, 세금계산서 발행, 차량 관리
  다. 보유기간: 계약 종료 후 5년 (상법 상사채권 소멸시효)
② 고객은 개인정보 수집에 대한 동의를 거부할 수 있으나, 이 경우 계약 체결이 제한될 수 있습니다.
③ 회사는 개인정보보호법에 따라 고객의 개인정보를 안전하게 관리합니다.',
   'privacy'),

  (v_terms_id, 22, '전자계약 및 전자서명',
   '① 본 계약은 전자문서 및 전자거래 기본법에 따른 전자계약으로 체결할 수 있습니다.
② 전자서명은 전자서명법 제3조에 의거 자필서명과 동일한 법적 효력을 가집니다.
③ 전자계약 체결 시 서명 일시, 서명자 정보(IP 주소 포함)가 기록·보관됩니다.
④ 전자계약서는 계약 당사자 모두에게 전자적 방법(이메일 등)으로 교부됩니다.',
   'general'),

  (v_terms_id, 23, '권리양도 금지',
   '① 고객은 본 계약에 따른 권리·의무를 회사의 사전 서면 동의 없이 제3자에게 양도하거나 담보로 제공할 수 없습니다.
② 회사는 본 계약에 따른 채권을 금융기관 등에 양도할 수 있으며, 이 경우 고객에게 통지합니다.',
   'other'),

  (v_terms_id, 24, '분쟁 해결',
   '① 본 계약에 관한 분쟁은 당사자 간 협의로 해결함을 원칙으로 합니다.
② 협의가 이루어지지 않을 경우, 민사소송법에 따른 관할법원에 소를 제기할 수 있습니다.
③ 본 계약에 명시되지 않은 사항은 여객자동차 운수사업법, 자동차관리법, 민법, 상법 등 관련 법령에 따릅니다.',
   'other');


  -- ── 특약사항 템플릿 ──
  INSERT INTO contract_special_terms (company_id, label, content, contract_type, is_default, sort_order) VALUES
  (v_company_id, '반납형 기본 특약',
   '본 계약은 반납형 장기렌트 계약으로, 계약 만기 시 차량을 회사에 반납하여야 합니다. 약정주행거리 초과분 및 차량 손상에 대한 정산이 이루어집니다.',
   'return', true, 1),
  (v_company_id, '인수형 기본 특약',
   '본 계약은 인수형 장기렌트 계약으로, 계약 만기 시 고객은 상기 명시된 인수가격(부가세 별도)을 납부하고 차량 소유권을 이전받을 수 있습니다. 인수를 포기하는 경우, 반납형 계약의 차량 반납 조건이 준용됩니다.',
   'buyout', true, 2),
  (v_company_id, '법인 리스백 특약',
   '본 계약은 법인 소유 차량의 리스백(Sale & Leaseback) 계약입니다. 차량 소유권은 회사에 이전되며, 대여기간 종료 시 잔존가격으로 재인수할 수 있습니다.',
   'all', false, 3),
  (v_company_id, '전기차 배터리 특약',
   '전기차의 고전압 배터리는 제조사 보증 범위(통상 8년/16만km)에 따르며, 보증 기간 내 성능 저하(SoH 70% 미만)는 제조사에 의해 교체됩니다. 정비상품 적용 대상에서 제외됩니다.',
   'all', false, 4);


  RAISE NOTICE '약관 시드 완료: terms_id = %, 24개 조항, 4개 특약 템플릿', v_terms_id;
END $$;
